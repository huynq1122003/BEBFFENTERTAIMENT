<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω Staff</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    main { margin-left: 240px; padding: 20px; }
    .actions { display: flex; justify-content: space-between; margin-bottom: 15px; }
    table { background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    th, td { vertical-align: middle; text-align: center; }
    td img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
    .password-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }
    .password-mask {
      font-family: "Courier New", monospace;
      letter-spacing: 2px;
    }
    .btn-eye {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
    }

    /* iOS-style toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4CAF50;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #4CAF50;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
  </style>
</head>
<body>
  <%- include("inc/header", { user: user }) %>

  <main>
    <h1>Danh s√°ch Staff</h1>
    <div class="actions">
      <input type="text" id="searchBox" class="form-control" placeholder="T√¨m t√™n ho·∫∑c email..." style="width:250px;">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStaffModal">+ Th√™m Staff</button>
    </div>

    <table id="staffTable" class="table table-bordered">
      <thead>
        <tr>
          <th>·∫¢nh</th>
          <th>T√™n</th>
          <th>Email</th>
          <th>SƒêT</th>
          <th>Ng√†y sinh</th>
          <th>Quy·ªÅn</th>
          <th>M·∫≠t kh·∫©u</th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <% staffList.forEach(staff => { %>
          <tr>
            <td><img src="<%= staff.img || '/images/default-avatar.png' %>"></td>
            <td><%= staff.Name %></td>
            <td><%= staff.Email %></td>
            <td><%= staff.phone %></td>
            <td><%= staff.BirthDay %></td>
            <td><%= staff.authority %></td>
            <td>
              <div class="password-wrapper">
                <span class="password-mask" data-pass="<%= staff.password || '' %>">
                  <%= staff.password ? '‚Ä¢'.repeat(staff.password.length) : '' %>
                </span>
                <% if (staff.password) { %>
                  <button class="btn-eye" type="button" onclick="togglePassword(this)">üëÅ</button>
                <% } %>
              </div>
            </td>

            <!-- Toggle tr·∫°ng th√°i -->
            <td>
              <label class="switch">
                <input type="checkbox" class="status-toggle" data-id="<%= staff.id %>" <%= staff.locked ? "" : "checked" %>>
                <span class="slider"></span>
              </label>
            </td>

            <!-- H√†nh ƒë·ªông -->
            <td>
              <button class="btn btn-sm btn-primary"
                data-staff='<%- JSON.stringify(staff) %>'
                onclick="openUpdateStaff(this)">‚úèÔ∏è</button>
              <a href="/admin/delete/<%= staff.id %>" class="btn btn-sm btn-danger">üóëÔ∏è</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </main>

  <!-- Modal Th√™m Staff -->
  <div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="/admin/add" method="POST" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Th√™m Staff</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" name="Name" class="form-control mb-2" placeholder="T√™n" required>
            <input type="email" name="Email" class="form-control mb-2" placeholder="Email" required>
            <input type="text" name="phone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
            <input type="date" name="BirthDay" class="form-control mb-2">
            <select name="authority" class="form-control mb-2">
              <option value="STAFF">STAFF</option>
              <option value="ADMIN">ADMIN</option>
            </select>
            <input type="password" name="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
            <input type="file" name="img" class="form-control">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Update Staff -->
  <div class="modal fade" id="updateStaffModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="updateStaffForm" method="POST" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">C·∫≠p nh·∫≠t Staff</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" name="Name" id="updateName" class="form-control mb-2" required>
            <input type="email" name="Email" id="updateEmail" class="form-control mb-2" required>
            <input type="text" name="phone" id="updatePhone" class="form-control mb-2">
            <input type="date" name="BirthDay" id="updateBirthDay" class="form-control mb-2">
            <select name="authority" id="updateAuthority" class="form-control mb-2">
              <option value="STAFF">STAFF</option>
              <option value="ADMIN">ADMIN</option>
            </select>
            <input type="password" name="password" id="updatePassword" class="form-control mb-2">
            <input type="file" name="img" class="form-control">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // search filter
    const searchBox = document.getElementById("searchBox");
    const rows = document.querySelectorAll("#staffTable tbody tr");
    searchBox.addEventListener("keyup", () => {
      const val = searchBox.value.toLowerCase();
      rows.forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none";
      });
    });

    // m·ªü modal update
    function openUpdateStaff(btn){
      const staff = JSON.parse(btn.getAttribute("data-staff"));
      document.getElementById("updateName").value = staff.Name || "";
      document.getElementById("updateEmail").value = staff.Email || "";
      document.getElementById("updatePhone").value = staff.phone || "";
      document.getElementById("updateBirthDay").value = staff.BirthDay || "";
      document.getElementById("updateAuthority").value = staff.authority || "STAFF";
      document.getElementById("updatePassword").value = staff.password || "";
      document.getElementById("updateStaffForm").action = "/admin/update/" + staff.id;

      var modal = new bootstrap.Modal(document.getElementById('updateStaffModal'));
      modal.show();
    }

    // ·∫©n/hi·ªán m·∫≠t kh·∫©u
    function togglePassword(btn){
      const span = btn.parentElement.querySelector(".password-mask");
      const original = span.getAttribute("data-pass");
      if(span.innerText.includes("‚Ä¢")){
        span.innerText = original; // show pass
      } else {
        span.innerText = "‚Ä¢".repeat(original.length); // hide pass
      }
    }

    // x·ª≠ l√Ω x√≥a staff v·ªõi SweetAlert2
    document.querySelectorAll("a[href*='/admin/delete/']").forEach(a => {
      a.addEventListener("click", function(e){
        e.preventDefault();
        const url = this.href;
        Swal.fire({
          title: "X√°c nh·∫≠n x√≥a?",
          text: "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a staff n√†y?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "C√≥, x√≥a",
          cancelButtonText: "H·ªßy",
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6c757d"
        }).then(result => {
          if(result.isConfirmed){
            window.location.href = url;
          }
        });
      });
    });

    // toggle iOS-style cho tr·∫°ng th√°i
    document.querySelectorAll(".status-toggle").forEach(toggle => {
      toggle.addEventListener("change", function(e){
        const id = this.getAttribute("data-id");
        const isActive = this.checked;
        const url = isActive ? `/admin/unlock/${id}` : `/admin/lock/${id}`;

        Swal.fire({
          title: isActive ? "M·ªü kh√≥a staff?" : "Kh√≥a staff?",
          text: isActive ? "Nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c m·ªü kh√≥a" : "Nh√¢n vi√™n s·∫Ω b·ªã kh√≥a",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "X√°c nh·∫≠n",
          cancelButtonText: "H·ªßy",
          confirmButtonColor: "#4CAF50",
          cancelButtonColor: "#6c757d"
        }).then(result => {
          if(result.isConfirmed){
            window.location.href = url;
          } else {
            this.checked = !isActive; // ho√†n t√°c n·∫øu h·ªßy
          }
        });
      });
    });
  </script>
</body>
</html>
